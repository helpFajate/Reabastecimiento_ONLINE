<!--
Autor y mantenimiento

Área de Sistemas — Vivell S.A.S

Desarrollado por:

Juan Sebastián Jaramillo (Ing. Industrial) aux.bi1@vivell.co
Melina Muñoz M. (Desarrolladora de Software) help.desk@vivell.co

Donde la visión estratégica y la implementación técnica se unen.
-->

<!DOCTYPE html>
<html lang="es">

<head>
    <!-- Codificación del documento -->
    <meta charset="UTF-8">
    <title>Sistema de Redistribución - Vivell</title>

    <!-- Librerías externas para estilos y animaciones -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js"></script>

    <!-- Fuente corporativa -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap"
        rel="stylesheet">

    <!-- Estilos personalizados -->
    <style>
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
        }

        /* Tarjeta con efecto glassmorphism */
        .glass-card {
            background: rgba(255, 255, 255, .8);
            backdrop-filter: blur(14px);
            border: 1px solid rgba(255, 255, 255, .4);
        }

        /* Contenedor del video */
        .video-container {
            mask-image: linear-gradient(to bottom, black 85%, transparent);
            border-radius: 2rem;
        }

        /* Personalización del slider */
        input[type="range"]::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background: #4f46e5;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 0 10px rgba(79, 70, 229, .4);
        }
    </style>
</head>

<body class="bg-[#f8fafc] min-h-screen overflow-x-hidden p-6">

    <!-- Contenedor raíz donde React renderiza la aplicación -->
    <div id="root"></div>

    <!-- Librerías necesarias para React -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script type="text/babel">
        // Hooks principales de React
        const { useState, useEffect } = React;

        /**
         * Componente principal del sistema de redistribución.
         * Controla el estado de la interfaz y la comunicación con el backend.
         */
        function RedistributionApp() {

            // Estado de la bodega seleccionada
            const [bodega, setBodega] = useState(7);

            // Estado del límite máximo permitido
            const [limite, setLimite] = useState(2);

            // Indica si el proceso está en ejecución
            const [isProcessing, setIsProcessing] = useState(false);

            // Paso actual del proceso
            const [currentStep, setCurrentStep] = useState('');

            // Porcentaje de avance
            const [progress, setProgress] = useState(0);

            // Resultado del backend
            const [result, setResult] = useState(null);

            // Mensaje de error
            const [error, setError] = useState(null);

            /**
             * Inicialización de iconos y animaciones al cargar la vista.
             */
            useEffect(() => {
                lucide.createIcons();

                anime.timeline({ easing: 'easeOutExpo' })
                    .add({ targets: '.hero-content', translateX: [-40, 0], opacity: [0, 1], duration: 1000 })
                    .add({ targets: '.config-panel', translateX: [40, 0], opacity: [0, 1], duration: 1000 }, '-=700');

                anime({
                    targets: '.floating-video',
                    translateY: [-10, 10],
                    direction: 'alternate',
                    loop: true,
                    duration: 3000,
                    easing: 'easeInOutQuad'
                });
            }, []);

            /**
             * Opciones de bodegas disponibles.
             */
            const bodegaOptions = [
                { value: 7, label: 'CEDI Central', desc: 'ID: 7 Distribución Nacional', icon: 'warehouse' },
                { value: 23, label: 'E-Commerce', desc: 'ID: 23 Canal Online', icon: 'globe' },
                { value: 118, label: 'Outlet Store', desc: 'ID: 118 Remanentes', icon: 'tag' }
            ];

            /**
             * Ejecuta el proceso de redistribución en el backend.
             */
            const executeProcess = async () => {
                setIsProcessing(true);
                setError(null);
                setResult(null);
                setProgress(0);

                try {
                    setCurrentStep('Ejecutando preprocesamiento...');
                    setProgress(25);
                    await new Promise(r => setTimeout(r, 500));

                    setCurrentStep('Añadiendo transferencias en tránsito...');
                    setProgress(50);
                    await new Promise(r => setTimeout(r, 500));

                    setCurrentStep('Ejecutando redistribución...');
                    setProgress(75);

                    const response = await fetch('/api/ejecutar', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ bodega, limite })
                    });

                    const data = await response.json();

                    if (data.success) {
                        setProgress(100);
                        setCurrentStep('¡Proceso completado!');
                        setResult({
                            bodega: bodegaOptions.find(b => b.value === bodega).label,
                            registros: data.registros,
                            filename: data.filename
                        });
                    } else {
                        throw new Error(data.error);
                    }
                } catch (err) {
                    setError('Error: ' + err.message);
                } finally {
                    setIsProcessing(false);
                }
            };

            /**
             * Descarga el archivo generado por el backend.
             */
            const downloadFile = () => {
                window.location.href = `/api/descargar/${result.filename}`;
            };

            return (
                <div className="min-h-screen flex flex-col">

                    <div className="max-w-7xl mx-auto w-full flex-1">

                        {/* Encabezado principal */}
                        <header className="flex justify-between items-center mb-12 hero-content">
                            <div>
                                <span className="text-indigo-600 font-bold tracking-widest text-xs uppercase">VIVELL</span>
                                <h1 className="text-4xl font-extrabold tracking-tight">
                                    Redistribución <span className="text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">Online</span>
                                </h1>
                            </div>

                            <div className="hidden md:block text-right border-l-2 border-slate-200 pl-6">
                                <p className="text-sm font-semibold text-slate-500 italic">
                                    "Nos apasionamos por tú bienestar"
                                </p>
                            </div>
                        </header>

                        <div className="grid lg:grid-cols-2 gap-16 items-center">

                            {/* Sección visual con video */}
                            <div className="relative floating-video hero-content">
                                <div className="absolute -inset-4 bg-gradient-to-tr from-indigo-500/10 to-purple-500/10 rounded-[3rem] blur-2xl"></div>
                                <div className="relative video-container shadow-2xl bg-white p-2">
                                    <video className="w-full rounded-[1.8rem]" autoPlay loop muted playsInline>
                                        <source src="Diseño sin título.mp4" type="video/mp4" />
                                    </video>
                                </div>

                                <div className="absolute -bottom-6 -right-6 glass-card p-6 rounded-2xl shadow-xl max-w-[200px] animate-pulse">
                                    <p className="text-[10px] uppercase text-slate-400 font-bold">Al ejecutar</p>
                                    <p className="text-xl font-extrabold text-indigo-600">esperar el 100%</p>
                                    <p className="text-xs text-slate-600">sincronizando existencias en tiempo real</p>
                                </div>
                            </div>

                            {/* Panel de configuración */}
                            <div className="config-panel">

                                <div className="glass-card rounded-[2.5rem] p-10 shadow-2xl mb-6 relative overflow-hidden">
                                    <div className="absolute top-0 right-0 p-8">
                                        <i data-lucide="cpu" className="w-12 h-12 text-indigo-500/10"></i>
                                    </div>

                                    <h2 className="text-2xl font-bold mb-8">Bodega de Origen</h2>

                                    <div className="space-y-8">

                                        {/* Selector de bodegas */}
                                        <div className="grid gap-4">
                                            {bodegaOptions.map(option => (
                                                <div key={option.value}
                                                    onClick={() => setBodega(option.value)}
                                                    className={`cursor-pointer p-4 rounded-2xl border-2 flex gap-4 transition ${bodega === option.value ? 'border-indigo-600 bg-white shadow-md' : 'border-transparent hover:bg-white/50'
                                                        }`}>
                                                    <div className={`p-3 rounded-xl ${bodega === option.value ? 'bg-indigo-600 text-white' : 'bg-slate-100 text-slate-400'}`}>
                                                        <i data-lucide={option.icon}></i>
                                                    </div>
                                                    <div>
                                                        <h3 className="font-bold">{option.label}</h3>
                                                        <p className="text-sm text-gray-500">{option.desc}</p>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>

                                        {/* Control del límite */}
                                        <div>
                                            <div className="flex justify-between items-end">
                                                <span className="text-sm font-bold text-slate-500 uppercase">Capacidad Máxima</span>
                                                <span className="text-3xl font-black text-indigo-600">{limite}</span>
                                            </div>
                                            <input type="range" min="1" max="10" value={limite}
                                                onChange={e => setLimite(parseInt(e.target.value))}
                                                className="w-full h-1.5 bg-slate-200 rounded-lg" />
                                        </div>

                                        {/* Botón de ejecución */}
                                        <button onClick={executeProcess}
                                            className="w-full py-5 bg-slate-900 hover:bg-indigo-600 text-white rounded-2xl font-bold text-lg shadow-xl transition">
                                            {isProcessing ? 'Procesando...' : 'Ejecutar Redistribución'}
                                        </button>

                                    </div>
                                </div>

                                {/* Barra de progreso */}
                                {isProcessing && (
                                    <div className="mt-6 glass-card p-4 rounded-xl">
                                        {currentStep} — {progress}%
                                        <div className="h-1 mt-3 bg-slate-200 rounded-full overflow-hidden">
                                            <div className="h-full bg-indigo-600 transition-all" style={{ width: progress + '%' }}></div>
                                        </div>
                                    </div>
                                )}

                                {/* Resultado del proceso */}
                                {result && (
                                    <div className="glass-card p-6 rounded-xl border-2 border-green-300 mt-6">
                                        <p>Bodega: {result.bodega}</p>
                                        <p>Registros: {result.registros}</p>
                                        <button onClick={downloadFile} className="mt-3 underline text-green-700">
                                            Descargar {result.filename}
                                        </button>
                                    </div>
                                )}

                                {/* Mensaje de error */}
                                {error && <div className="bg-red-100 p-4 rounded-lg mt-4">{error}</div>}

                            </div>
                        </div>
                    </div>

                    {/* Pie de página */}
                    <footer className="mt-12 text-center text-sm text-slate-400">
                        <div className="border-t pt-6">
                            © 2026 Todos los derechos reservados — Desarrollado por el área de Sistemas Vivell S.A.S
                        </div>
                    </footer>

                </div>
            );
        }

        // Renderizado del componente principal
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<RedistributionApp />);
    </script>
</body>

</html>
